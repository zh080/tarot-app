<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>灵感塔罗 | 你的口袋占卜学院</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#F9F7F2;
      --text:#242424;
      --sub:#6b6b6b;
      --accent:#D4A373;
      --border:#e0e0e0;

      --cardW: 118px;
      --ratio: 1.71;
      --cardH: calc(var(--cardW) * var(--ratio));
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:'Inter',sans-serif; -webkit-font-smoothing:antialiased; line-height:1.6;
      overflow-x:hidden;
    }
    header{
      position:sticky; top:0; z-index:30;
      background:#fff; border-bottom:1px solid var(--border);
      padding:18px 0; text-align:center;
    }
    .brand{
      text-decoration:none; color:#1a1a1a; letter-spacing:1px;
      font-size:1.45rem; font-family:'Playfair Display',serif; font-weight:700;
    }
    .container{ max-width: 1020px; margin: 14px auto 80px; padding:0 16px; position:relative; z-index:1; }

    .paper-grain{
      position:fixed; inset:0; pointer-events:none; z-index:0;
      background-image:
        radial-gradient(circle at 10% 10%, rgba(0,0,0,.03), rgba(0,0,0,0) 35%),
        radial-gradient(circle at 90% 30%, rgba(0,0,0,.02), rgba(0,0,0,0) 40%),
        repeating-linear-gradient(45deg, rgba(0,0,0,.012) 0 2px, rgba(0,0,0,0) 2px 7px);
      opacity:.55; mix-blend-mode:multiply;
    }

    .book{
      position:relative;
      width: min(980px, 96vw);
      margin: 18px auto 0;
      height: min(760px, calc(100vh - 120px));
      perspective: 1400px;
    }
    .page{
      position:absolute; inset:0;
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 22px;
      box-shadow: 0 24px 64px rgba(0,0,0,.10);
      backdrop-filter: blur(6px);
      overflow:hidden;

      transform-origin: left center;
      transform-style: preserve-3d;
      transition: transform 1s cubic-bezier(.2,.85,.2,1), opacity .5s ease;
      opacity: 1;
    }
    .page::before{
      content:"";
      position:absolute; inset:-60px;
      background:
        radial-gradient(circle at 30% 20%, rgba(212,163,115,.18), rgba(212,163,115,0) 55%),
        radial-gradient(circle at 82% 70%, rgba(0,0,0,.04), rgba(0,0,0,0) 60%);
      pointer-events:none;
    }
    .page-inner{
      position:relative;
      height:100%;
      padding: 26px 20px 20px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 14px;
    }

    .page.prev{ transform: rotateY(-180deg); opacity:0; pointer-events:none; }
    .page.current{ transform: rotateY(0deg); opacity:1; pointer-events:auto; }
    .page.next{ transform: rotateY(180deg); opacity:0; pointer-events:none; }

    .btn{
      background:#111; color:#fff; border:none;
      padding:12px 28px; border-radius:999px;
      font-size:1rem; font-weight:900; cursor:pointer;
      transition: transform .16s ease, opacity .16s ease;
    }
    .btn:hover{ transform: scale(1.03); }
    .btn.secondary{ background:#fff; color:#222; border:1px solid #222; }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; }

    input[type="text"]{
      width:100%; max-width:640px;
      border:none; border-bottom:2px solid #cfcfcf;
      background:transparent;
      font-family:'Playfair Display',serif;
      font-size: 1.45rem; color:var(--text);
      padding: 10px 0; text-align:center; outline:none;
      transition:.25s;
      position:relative;
    }
    input[type="text"]:focus{ border-color:#111; }

    .home-title{
      font-family:'Playfair Display',serif;
      font-size: 2.25rem;
      margin: 0;
      color:#1a1a1a;
      position:relative;
      text-align:center;
    }
    .home-sub{
      color:var(--sub);
      margin: 0;
      position:relative;
      text-align:center;
      max-width: 720px;
    }
    .ghost-wrap{
      width: 132px; height: 132px;
      position:relative;
      filter: drop-shadow(0 18px 22px rgba(0,0,0,.12));
      animation: floaty 3.8s ease-in-out infinite;
      margin-bottom: 2px;
    }
    @keyframes floaty{
      0%,100%{ transform: translateY(0) rotate(-1deg); }
      50%{ transform: translateY(-14px) rotate(1deg); }
    }
    .ghost{
      position:absolute; inset:0;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.95), rgba(255,255,255,.78) 55%, rgba(255,255,255,.65));
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 56px 56px 46px 46px;
      overflow:hidden;
    }
    .ghost::before{
      content:"";
      position:absolute; left:-26px; top:-18px;
      width: 128px; height: 128px;
      background: radial-gradient(circle at 60% 60%, rgba(212,163,115,.22), rgba(212,163,115,0) 70%);
      transform: rotate(18deg);
    }
    .ghost::after{
      content:"";
      position:absolute; left:0; right:0; bottom:-18px;
      height: 56px;
      background:
        radial-gradient(circle at 14% 30%, rgba(255,255,255,.82) 0 18px, rgba(255,255,255,0) 19px),
        radial-gradient(circle at 37% 45%, rgba(255,255,255,.78) 0 18px, rgba(255,255,255,0) 19px),
        radial-gradient(circle at 62% 28%, rgba(255,255,255,.84) 0 18px, rgba(255,255,255,0) 19px),
        radial-gradient(circle at 86% 48%, rgba(255,255,255,.76) 0 18px, rgba(255,255,255,0) 19px);
      opacity:.95;
      animation: wobble 2.7s ease-in-out infinite;
    }
    @keyframes wobble{
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(4px); }
    }
    .eyes{
      position:absolute; top:48px; left:0; right:0;
      display:flex; justify-content:center; gap:14px;
    }
    .eye{
      width: 10px; height: 14px; border-radius: 999px;
      background: rgba(20,20,20,.78);
      box-shadow: 0 0 0 6px rgba(0,0,0,.02);
      animation: blink 5.2s infinite;
    }
    @keyframes blink{
      0%, 92%, 100%{ transform: scaleY(1); }
      94%{ transform: scaleY(.2); }
      96%{ transform: scaleY(1); }
    }
    .home-actions{
      display:flex; gap:12px; flex-wrap:wrap; justify-content:center;
      margin-top: 8px;
    }

    .stage-title{
      font-family:'Playfair Display',serif;
      font-size: 2rem;
      margin: 0;
      color:#1a1a1a;
      text-align:center;
    }
    .stage-sub{
      color:var(--sub);
      text-align:center;
      margin: 0;
      max-width: 820px;
    }
    .picked-row{
      display:flex; gap:12px; justify-content:center; flex-wrap:wrap;
      padding: 10px 0 14px; margin: 6px 0 8px;
      border-bottom: 1px solid rgba(0,0,0,.06);
      min-height: calc(var(--cardH) + 14px);
      width: 100%;
      max-width: 980px;
    }
    .slot{
      width: var(--cardW); height: var(--cardH);
      border-radius: 14px;
      border: 1px dashed rgba(0,0,0,.18);
      background: rgba(255,255,255,.35);
    }

    .deck-area{
      position: relative;
      width: 100%;
      max-width: 980px;
      height: 430px;
      margin-top: 4px;
      display:flex;
      justify-content:center;
      align-items:flex-end;
      padding-bottom: 28px;
    }
    .pile-shadow{
      position:absolute;
      bottom: 38px;
      width: min(620px, 92vw);
      height: 320px;
      border-radius: 26px;
      background: radial-gradient(ellipse at center, rgba(0,0,0,.10), rgba(0,0,0,0) 68%);
      pointer-events:none;
      filter: blur(.4px);
    }

    #spellCanvas{
      position:absolute;
      inset: 0;
      width:100%;
      height:100%;
      pointer-events:none;
      opacity: .95;
      mix-blend-mode: multiply;
    }

    .tarot-card{
      width: var(--cardW);
      height: var(--cardH);
      position:absolute;
      bottom: 78px;
      left: 50%;
      transform: translateX(-50%);
      perspective: 1100px;
      cursor:pointer;
      border-radius: 14px;
      user-select:none;

      transition: transform .18s ease, filter .18s ease, opacity .28s ease;
      will-change: transform;
    }
    .tarot-card .card-inner{
      width:100%; height:100%;
      position:relative;
      transform-style:preserve-3d;
      transition: transform .9s cubic-bezier(.2,.8,.2,1);
      border-radius:14px;
    }
    .tarot-card .face{
      position:absolute; inset:0;
      border-radius:14px;
      overflow:hidden;
      backface-visibility:hidden;
    }
    .card-back{
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.10), rgba(255,255,255,0) 40%),
        linear-gradient(135deg, #141414, #262626 55%, #101010);
      border: 1px solid rgba(255,255,255,.25);
      box-shadow:
        0 18px 38px rgba(0,0,0,.24),
        0 2px 0 rgba(255,255,255,.08) inset,
        0 -2px 0 rgba(0,0,0,.25) inset;
      display:flex; align-items:center; justify-content:center;
      color:#D4A373; font-size: 1.9rem;
      position:relative;
    }
    .card-back::before{
      content:"";
      position:absolute; inset:10px;
      border-radius: 10px;
      border: 1px solid rgba(212,163,115,.35);
      background-image:
        repeating-linear-gradient(45deg, rgba(255,255,255,.035) 0 2px, rgba(0,0,0,0) 2px 6px);
      mix-blend-mode: overlay;
      pointer-events:none;
    }
    .card-back::after{
      content:"";
      position:absolute;
      left: 3px; right: 3px;
      bottom: -7px;
      height: 11px;
      border-radius: 0 0 14px 14px;
      background: linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,0));
      pointer-events:none;
    }
    .card-front{
      transform: rotateY(180deg);
      background:#fff;
      background-size: cover;
      background-position:center;
      box-shadow:
        0 18px 36px rgba(0,0,0,.20),
        0 0 0 1px rgba(0,0,0,.08) inset;
      position:relative;
    }
    .card-front::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(120deg, rgba(255,255,255,0) 35%, rgba(255,255,255,.16) 50%, rgba(255,255,255,0) 65%);
      transform: translateX(-80%);
      opacity: 0;
      pointer-events:none;
    }
    .tarot-card:hover .card-front::after{
      opacity:1;
      animation: gloss .9s ease;
    }
    @keyframes gloss{
      0%{ transform: translateX(-80%); }
      100%{ transform: translateX(80%); }
    }

    .tarot-card.flipped .card-inner{ transform: rotateY(180deg); }

    .tarot-card.stack{
      transform: translateX(-50%) translate(0px, 0px) rotate(0deg);
      filter: saturate(1);
    }
    .tarot-card.fan{
      transform: translateX(-50%) translate(var(--x), var(--y)) rotate(var(--r));
    }
    .tarot-card.fan:hover{
      z-index: 80;
      transform: translateX(-50%) translate(var(--x), var(--y)) rotate(var(--r))
                 translateY(-16px) translateX(var(--pullx));
      filter: saturate(1.03) contrast(1.02);
    }

    .tarot-card.pulling{
      z-index: 200;
      transform: translateX(-50%) translate(var(--x), var(--y)) rotate(var(--r))
                 translateY(-160px) translateX(var(--pullx)) scale(1.02) !important;
      transition: transform .22s ease;
      pointer-events:none;
    }
    .tarot-card.gone{ opacity:0; pointer-events:none; }

    .tarot-card.shuffle-jitter{
      animation: jitter .20s ease-in-out infinite;
    }
    @keyframes jitter{
      0%,100%{ transform: translateX(-50%) translate(0px,0px) rotate(0deg); }
      50%{ transform: translateX(-50%) translate(2px,-2px) rotate(1deg); }
    }
    .tarot-card.cut-left{
      transform: translateX(-50%) translate(-36px, -12px) rotate(-4deg) !important;
      transition: transform .24s ease;
    }
    .tarot-card.cut-right{
      transform: translateX(-50%) translate(36px, 8px) rotate(4deg) !important;
      transition: transform .24s ease;
    }

    .spread-row{
      display:flex; gap: 14px; justify-content:center; flex-wrap:wrap;
      margin: 6px 0 12px;
      width:100%;
      max-width: 980px;
    }
    .spread-card{
      width: var(--cardW); height: var(--cardH);
      border-radius:14px; position:relative; perspective:1100px;
      cursor:pointer;
      transition: transform .16s ease, filter .16s ease;
    }
    .spread-card:hover{ transform: translateY(-8px); filter: saturate(1.02); }
    .spread-card .card-inner{
      width:100%; height:100%; position:relative; transform-style:preserve-3d;
      transition: transform .95s cubic-bezier(.2,.8,.2,1); border-radius:14px;
    }
    .spread-card .face{ position:absolute; inset:0; border-radius:14px; overflow:hidden; backface-visibility:hidden; }
    .spread-card .card-front{ transform: rotateY(180deg); }
    .spread-card.flipped .card-inner{ transform: rotateY(180deg); }

    .detail-panel{
      width:100%;
      max-width: 980px;
      margin-top: 6px;
      background: rgba(255,255,255,.85);
      border:1px solid rgba(0,0,0,.06);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 18px 44px rgba(0,0,0,.08);
      backdrop-filter: blur(6px);
      position:relative;
      overflow:hidden;
    }
    .detail-panel::before{
      content:"";
      position:absolute; inset:-60px;
      background:
        radial-gradient(circle at 25% 15%, rgba(212,163,115,.18), rgba(212,163,115,0) 55%),
        radial-gradient(circle at 78% 70%, rgba(0,0,0,.04), rgba(0,0,0,0) 60%);
      pointer-events:none;
    }
    .detail-title{
      display:flex; align-items:baseline; justify-content:center; gap:10px;
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(0,0,0,.06);
      padding-bottom: 10px;
      position:relative;
    }
    .detail-title .en{
      font-size:.85rem; color:var(--sub);
      letter-spacing:1.5px; text-transform:uppercase;
    }
    .detail-title .cn{
      font-size:1.9rem;
      font-family:'Playfair Display',serif;
    }
    .block-label{
      display:block;
      font-size: 0.78rem;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--accent);
      margin: 12px 0 10px;
      position:relative;
    }
    .speech-bubble{
      background:#fff;
      padding: 18px 18px;
      border-radius: 0 16px 16px 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.06);
      position: relative;
    }
    .speech-text{
      font-family:'Playfair Display',serif;
      font-size: 1.12rem;
      color:#2c3e50;
      line-height:1.75;
      font-style: italic;
      margin:0;
    }
    .speech-text::before{
      content:"“";
      font-size: 3rem;
      color:#e5e5e5;
      position:absolute;
      top:-14px; left:10px;
      font-family: serif;
    }
    .edu-box{
      background:#fff;
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 16px;
      padding: 16px;
      color:#555;
    }
    .highlight{
      background: linear-gradient(120deg, #f6d365 0%, #fda085 100%);
      background-repeat: no-repeat;
      background-size: 100% 0.2em;
      background-position: 0 88%;
      font-weight: bold;
      color: #000;
    }
    .actions{
      display:flex;
      justify-content:center;
      gap: 12px;
      margin-top: 16px;
      position:relative;
      flex-wrap:wrap;
    }

    .final-text{
      max-width: 820px;
      text-align:center;
      font-family:'Playfair Display',serif;
      font-size: 1.55rem;
      line-height: 1.8;
      color:#1f1f1f;
      opacity: 0;
      transform: translateY(12px);
      transition: opacity 1.2s ease, transform 1.2s ease;
      background:#fff;
      border:1px solid var(--border);
      border-radius: 18px;
      padding: 26px 18px;
      box-shadow: 0 14px 36px rgba(0,0,0,.07);
    }
    .final-text.show{ opacity:1; transform: translateY(0); }

    .toast{
      position: fixed;
      left:50%; bottom: 26px;
      transform: translateX(-50%);
      background: rgba(20,20,20,.92);
      color:#fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: .9rem;
      opacity:0;
      pointer-events:none;
      transition: opacity .25s ease, transform .25s ease;
      z-index: 999;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-6px); }

    .particle{
      position: fixed;
      width: 6px; height: 6px;
      border-radius: 999px;
      pointer-events:none;
      z-index: 9999;
      background: radial-gradient(circle, rgba(212,163,115,.95), rgba(212,163,115,0) 70%);
      animation: pFloat .65s ease-out forwards;
    }
    @keyframes pFloat{
      0%{ transform: translate(0,0) scale(.7); opacity:.95; }
      100%{ transform: translate(var(--dx), var(--dy)) scale(1.4); opacity:0; }
    }

    .tip{
      color: var(--sub);
      font-size: .92rem;
      text-align:center;
      margin-top: 4px;
      max-width: 900px;
    }
    .kbd{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 8px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.8);
      font-weight: 800;
      font-size: .86rem;
      color:#222;
    }
  </style>
</head>

<body>
<div class="paper-grain"></div>
<header><a class="brand" href="#">Tarot Insight</a></header>

<div class="container">
  <div class="book" id="book">

    <!-- PAGE 1 -->
    <section class="page current" id="page1">
      <div class="page-inner">
        <div class="ghost-wrap" aria-hidden="true">
          <div class="ghost">
            <div class="eyes">
              <div class="eye"></div>
              <div class="eye"></div>
            </div>
          </div>
        </div>

        <h1 class="home-title">你有什么问题？</h1>
        <p class="home-sub">写下来就好。接下来，让牌替你把思路照亮一点。</p>

        <input type="text" id="userQuestion" placeholder="例如：我该不该换工作？/ 我如何走出焦虑？/ 这段关系值不值得继续？" />
        <div class="home-actions">
          <button class="btn" id="btnStart">开始洗牌</button>
          <button class="btn secondary" id="btnDemo" title="不输入也能体验">随便问一个</button>
        </div>
        <div class="tip">小技巧：你也可以直接按 <span class="kbd">Enter</span> 开始洗牌。</div>
      </div>
    </section>

    <!-- PAGE 2 -->
    <section class="page next" id="page2">
      <div class="page-inner" style="justify-content:flex-start; gap:10px;">
        <div style="margin-top:4px;">
          <div class="stage-title">抽取 7 张牌</div>
          <p class="stage-sub">把鼠标放在牌上，它会像被你“从堆顶抽出”一点点；点击即可收进上方。</p>
          <div class="tip">施法：在牌堆上按住鼠标画一个圈（或按 <span class="kbd">R</span>）→ 重新洗牌。</div>
        </div>

        <div class="picked-row" id="pickedRow"></div>

        <div class="deck-area" id="deckArea">
          <div class="pile-shadow"></div>
          <canvas id="spellCanvas"></canvas>
        </div>

        <div style="text-align:center;">
          <button class="btn secondary" id="btnReset">重新开始</button>
        </div>
      </div>
    </section>

    <!-- PAGE 3 -->
    <section class="page next" id="page3">
      <div class="page-inner" style="justify-content:flex-start; gap:10px;">
        <div style="margin-top:4px;">
          <div class="stage-title">你的 7 张牌</div>
          <p class="stage-sub">逐张点击查看解析。看完 7 张后，Next 才会解锁。</p>
        </div>

        <div class="spread-row" id="spreadRow"></div>

        <div class="detail-panel" id="detailPanel" style="display:none;">
          <div class="detail-title">
            <div class="en" id="dEn"></div>
            <div class="cn" id="dCn"></div>
          </div>

          <span class="block-label">Insight / 对话式指引</span>
          <div class="speech-bubble">
            <p class="speech-text" id="dVoice"></p>
          </div>

          <span class="block-label">Card Imagery / 画面解码</span>
          <div class="edu-box" id="dDesc"></div>

          <div class="actions">
            <button class="btn secondary" onclick="location.reload()">New Reading</button>
            <button class="btn" id="btnNext" disabled>Next</button>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE 4 -->
    <section class="page next" id="page4">
      <div class="page-inner">
        <div class="final-text" id="finalText"></div>
        <div style="text-align:center; margin-top: 8px;">
          <button class="btn" onclick="location.reload()">再来一次</button>
        </div>
      </div>
    </section>

  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // 真实牌面：Wikimedia 文件名 -> 直链显示
  const WIKI_BASE = "https://commons.wikimedia.org/wiki/Special:FilePath/";
  const wikiUrl = (fileName) => WIKI_BASE + encodeURIComponent(fileName || "");

  const $ = (id) => document.getElementById(id);

  // -------------------------
  // UI helpers
  // -------------------------
  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1400);
  }

  function sparkleAt(x, y, intensity=7){
    for(let i=0;i<intensity;i++){
      const p = document.createElement("div");
      p.className = "particle";
      const dx = (Math.random()*2-1) * (20 + Math.random()*25);
      const dy = (-1) * (18 + Math.random()*40);
      p.style.left = (x + (Math.random()*10-5)) + "px";
      p.style.top = (y + (Math.random()*10-5)) + "px";
      p.style.setProperty("--dx", dx.toFixed(1)+"px");
      p.style.setProperty("--dy", dy.toFixed(1)+"px");
      document.body.appendChild(p);
      setTimeout(()=>p.remove(), 700);
    }
  }

  // 轻音效（可删：不影响功能）
  let audioCtx = null;
  function chime(){
    try{
      audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      o.frequency.setValueAtTime(680, audioCtx.currentTime);
      o.frequency.exponentialRampToValueAtTime(1020, audioCtx.currentTime + 0.09);
      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.055, audioCtx.currentTime + 0.012);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.18);
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      o.stop(audioCtx.currentTime + 0.2);
    }catch(e){}
  }

  // -------------------------
  // Book page flip
  // -------------------------
  const pages = [$("page1"), $("page2"), $("page3"), $("page4")];
  let currentPage = 0;
  function goPage(idx){
    currentPage = idx;
    pages.forEach((p, i)=>{
      p.classList.remove("prev","current","next");
      if(i < idx) p.classList.add("prev");
      else if(i === idx) p.classList.add("current");
      else p.classList.add("next");
    });
    sparkleAt(window.innerWidth/2, window.innerHeight/2, 10);
  }

  // -------------------------
  // State
  // -------------------------
  let shuffleId = null;
  let poolIds = [];     // 8张
  let pickedIds = [];   // 7张
  let pickedMeta = [];  // 7张详情
  let closingLine = "";
  let question = "";
  let viewed = new Set();

  // -------------------------
  // Page 1 interactions
  // -------------------------
  $("btnDemo").addEventListener("click", ()=>{
    const demoQs = [
      "我该不该换工作？",
      "这段关系值得继续吗？",
      "我怎么走出焦虑和内耗？",
      "我该如何做出这个选择？",
      "我真正想要的是什么？"
    ];
    $("userQuestion").value = demoQs[Math.floor(Math.random()*demoQs.length)];
    chime();
    sparkleAt(window.innerWidth/2, window.innerHeight/2, 12);
  });

  $("userQuestion").addEventListener("keydown", (e)=>{
    if(e.key === "Enter") $("btnStart").click();
  });

  $("btnStart").addEventListener("click", async ()=>{
    question = $("userQuestion").value.trim();
    if(!question){
      toast("先写一句你的问题。");
      return;
    }
    await doShuffle(true);
    goPage(1);
  });

  $("btnReset").addEventListener("click", ()=>location.reload());

  // -------------------------
  // Shuffle: backend changes + frontend ritual animation
  // -------------------------
  async function doShuffle(showToast){
    const r = await fetch("/api/shuffle");
    const data = await r.json();
    if(data.error){ alert(data.error); return; }
    shuffleId = data.shuffleId;
    poolIds = data.pool;

    pickedIds = [];
    viewed = new Set();

    renderPickStage();
    await animateShuffle();

    if(showToast) toast("牌已洗好。开始抽 7 张。");
  }

  function renderPickStage(){
    $("pickedRow").innerHTML = "";
    for(let i=0;i<7;i++){
      const slot = document.createElement("div");
      slot.className = "slot";
      $("pickedRow").appendChild(slot);
    }

    $("deckArea").querySelectorAll(".tarot-card").forEach(n=>n.remove());

    const fan = [
      {x:-220, y: 36, r:-18, pullx:-12},
      {x:-160, y: 24, r:-13, pullx:-10},
      {x:-100, y: 14, r:-9,  pullx:-8},
      {x:-40,  y:  8, r:-4,  pullx:-4},
      {x: 40,  y:  8, r: 4,  pullx: 4},
      {x: 100, y: 14, r: 9,  pullx: 8},
      {x: 160, y: 24, r: 13, pullx: 10},
      {x: 220, y: 36, r: 18, pullx: 12}
    ];

    poolIds.forEach((id, i)=>{
      const cfg = fan[i] || {x:0,y:0,r:0,pullx:0};
      const c = document.createElement("div");
      c.className = "tarot-card stack";
      c.dataset.id = id;

      c.style.setProperty("--x", cfg.x + "px");
      c.style.setProperty("--y", (-cfg.y) + "px");
      c.style.setProperty("--r", cfg.r + "deg");
      c.style.setProperty("--pullx", cfg.pullx + "px");
      c.style.zIndex = 20 + i;

      c.innerHTML = `
        <div class="card-inner">
          <div class="face card-front"></div>
          <div class="face card-back">✦</div>
        </div>
      `;

      c.addEventListener("mouseenter", ()=>{
        const rect = c.getBoundingClientRect();
        sparkleAt(rect.left + rect.width/2, rect.top + rect.height/2, 4);
      });

      c.addEventListener("click", (e)=>pickCard(c, e));
      $("deckArea").appendChild(c);
    });
  }

  async function animateShuffle(){
    const cards = Array.from($("deckArea").querySelectorAll(".tarot-card"));
    if(!cards.length) return;

    // 1) 抖动
    cards.forEach(c=>c.classList.add("shuffle-jitter"));
    await sleep(420);

    // 2) 切牌
    cards.forEach((c, i)=>{
      if(i < cards.length/2) c.classList.add("cut-left");
      else c.classList.add("cut-right");
    });
    chime();
    await sleep(320);

    // 3) 回堆  ✅✅✅ 这里是你原来漏掉的括号/结束符，导致后面全部报错
    cards.forEach(c=>{
      c.classList.remove("cut-left","cut-right");
    });
    triggeringReflow(cards[0]); // 让 transition 生效
    await sleep(220);

    await sleep(260);

    // 4) 停止抖动
    cards.forEach(c=>c.classList.remove("shuffle-jitter"));
    await sleep(120);

    // 5) 展开扇形：逐张展开
    cards.forEach((c, i)=>{
      setTimeout(()=>{
        c.classList.remove("stack");
        c.classList.add("fan");
      }, 70 + i*70);
    });
  }

  function triggeringReflow(el){ void el.offsetHeight; }
  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

  // -------------------------
  // Pick card
  // -------------------------
  function pickCard(cardEl, evt){
    const id = Number(cardEl.dataset.id);
    if(pickedIds.includes(id)) return;
    if(pickedIds.length >= 7){ toast("已经选满 7 张。"); return; }

    pickedIds.push(id);
    chime();

    cardEl.classList.add("pulling");

    const clickX = evt?.clientX ?? (window.innerWidth/2);
    const clickY = evt?.clientY ?? (window.innerHeight/2);
    sparkleAt(clickX, clickY, 12);

    const slot = $("pickedRow").children[pickedIds.length-1];
    const slotRect = slot.getBoundingClientRect();
    const fromRect = cardEl.getBoundingClientRect();

    const flyer = cardEl.cloneNode(true);
    flyer.classList.remove("fan");
    flyer.classList.add("pulling");
    flyer.style.position = "fixed";
    flyer.style.left = fromRect.left + "px";
    flyer.style.top = fromRect.top + "px";
    flyer.style.bottom = "auto";
    flyer.style.transform = "none";
    flyer.style.margin = "0";
    flyer.style.zIndex = 9999;
    flyer.style.transition = "transform .38s cubic-bezier(.2,.8,.2,1), opacity .25s ease";
    document.body.appendChild(flyer);

    setTimeout(()=>{ cardEl.classList.add("gone"); }, 90);

    requestAnimationFrame(()=>{
      const dx = (slotRect.left - fromRect.left);
      const dy = (slotRect.top - fromRect.top);
      flyer.style.transform = `translate(${dx}px, ${dy}px) scale(0.98)`;
    });

    setTimeout(()=>{
      flyer.remove();
      fillSlotBack(slot);

      if(pickedIds.length === 7){
        setTimeout(()=>finalizePick(), 460);
      }else{
        toast(`已抽 ${pickedIds.length}/7 张`);
      }
    }, 420);
  }

  function fillSlotBack(slot){
    slot.style.border = "none";
    slot.style.background = "transparent";
    slot.style.boxShadow = "0 10px 22px rgba(0,0,0,.12)";
    slot.style.overflow = "hidden";
    slot.innerHTML = `
      <div style="
        width:100%;height:100%;
        border-radius:14px;
        background: linear-gradient(135deg, #141414, #262626 55%, #101010);
        border: 1px solid rgba(255,255,255,.25);
        box-shadow: 0 10px 22px rgba(0,0,0,.18);
        display:flex;align-items:center;justify-content:center;
        color:#D4A373;font-size:1.6rem;">
        ✦
      </div>
    `;
  }

  // -------------------------
  // Reading & spread
  // -------------------------
  async function finalizePick(){
    toast("好，我们翻开你的 7 张牌。");

    const r = await fetch("/api/reading", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ shuffleId, question, picks: pickedIds })
    });
    const data = await r.json();
    if(data.error){ alert(data.error); return; }

    pickedMeta = data.cards || [];
    closingLine = data.closing || "";

    goPage(2);
    renderSpread(pickedMeta);
  }

  function renderSpread(cards){
    $("spreadRow").innerHTML = "";
    $("detailPanel").style.display = "none";
    viewed = new Set();
    $("btnNext").disabled = true;

    cards.forEach((card, idx)=>{
      const el = document.createElement("div");
      el.className = "spread-card";
      el.dataset.idx = idx;

      el.innerHTML = `
        <div class="card-inner">
          <div class="face card-front"></div>
          <div class="face card-back">✦</div>
        </div>
      `;

      const front = el.querySelector(".card-front");
      front.style.backgroundImage = `url('${wikiUrl(card.img)}')`;

      el.addEventListener("click", ()=>{
        const rect = el.getBoundingClientRect();
        sparkleAt(rect.left + rect.width/2, rect.top + rect.height/2, 10);
        chime();
        selectCard(idx);
      });

      $("spreadRow").appendChild(el);
    });

    const els = Array.from(document.querySelectorAll(".spread-card"));
    els.forEach((el, i)=>{
      setTimeout(()=> el.classList.add("flipped"), 420 + i * 220);
    });

    setTimeout(()=> selectCard(0), 420 + els.length * 220 + 260);
  }

  function selectCard(idx){
    const card = pickedMeta[idx];
    if(!card) return;

    viewed.add(idx);

    $("dEn").textContent = (card.en || "").toUpperCase();
    $("dCn").textContent = card.name || "";
    $("dVoice").textContent = card.voice || "";
    $("dDesc").innerHTML = card.desc || "";

    $("detailPanel").style.display = "block";

    if(viewed.size >= 7){
      $("btnNext").disabled = false;
      toast("你已看完 7 张，Next 已解锁。");
    }else{
      toast(`已看 ${viewed.size}/7 张`);
    }
  }

  $("btnNext").addEventListener("click", ()=>{
    if(viewed.size < 7){
      toast("请先看完 7 张解析。");
      return;
    }
    goPage(3);
    const box = $("finalText");
    box.textContent = closingLine || "这是你的世界，一切可能性都存在于当下，选择就好了。亲爱的，勇敢去做出选择吧。";
    setTimeout(()=> box.classList.add("show"), 240);
  });

  // -------------------------
  // Gesture spell: draw a circle on deck to reshuffle
  // -------------------------
  const deckArea = $("deckArea");
  const canvas = $("spellCanvas");
  const ctx = canvas.getContext("2d");

  function resizeCanvas(){
    const rect = deckArea.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * devicePixelRatio);
    canvas.height = Math.floor(rect.height * devicePixelRatio);
    canvas.style.width = rect.width + "px";
    canvas.style.height = rect.height + "px";
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
  }
  window.addEventListener("resize", ()=>{ if(currentPage===1) resizeCanvas(); });

  let drawing = false;
  let points = [];
  let fadeTimer = null;

  function startStroke(x, y){
    resizeCanvas();
    drawing = true;
    points = [{x,y,t:Date.now()}];
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle = "rgba(212,163,115,0.75)";
    ctx.lineWidth = 4.2;
    ctx.beginPath();
    ctx.moveTo(x,y);
    sparkleAt(deckArea.getBoundingClientRect().left + x, deckArea.getBoundingClientRect().top + y, 6);
  }
  function moveStroke(x, y){
    if(!drawing) return;
    points.push({x,y,t:Date.now()});
    ctx.lineTo(x,y);
    ctx.stroke();
  }
  async function endStroke(){
    if(!drawing) return;
    drawing = false;

    const ok = isCircle(points);

    if(fadeTimer) clearInterval(fadeTimer);
    fadeTimer = setInterval(()=>{
      ctx.fillStyle = `rgba(249,247,242,0.06)`;
      ctx.fillRect(0,0,canvas.width,canvas.height);
    }, 40);

    setTimeout(()=>{
      if(fadeTimer){ clearInterval(fadeTimer); fadeTimer=null; }
      ctx.clearRect(0,0,canvas.width,canvas.height);
    }, 800);

    if(ok){
      toast("✨ 施法成功：重新洗牌");
      chime();
      const rect = deckArea.getBoundingClientRect();
      sparkleAt(rect.left + rect.width/2, rect.top + rect.height/2, 18);
      await doShuffle(false);
    }
  }

  function isCircle(pts){
    if(!pts || pts.length < 25) return false;
    const start = pts[0], end = pts[pts.length-1];
    const dx = end.x - start.x, dy = end.y - start.y;
    const dist = Math.hypot(dx,dy);
    if(dist > 30) return false;

    let minX=Infinity, maxX=-Infinity, minY=Infinity, maxY=-Infinity;
    for(const p of pts){
      minX = Math.min(minX, p.x); maxX = Math.max(maxX, p.x);
      minY = Math.min(minY, p.y); maxY = Math.max(maxY, p.y);
    }
    const w = maxX - minX, h = maxY - minY;
    if(w < 90 || h < 90) return false;
    const cx = (minX + maxX)/2, cy = (minY + maxY)/2;

    let q = [0,0,0,0];
    for(const p of pts){
      const ax = p.x - cx, ay = p.y - cy;
      if(ax>=0 && ay<0) q[0]=1;
      if(ax<0 && ay<0) q[1]=1;
      if(ax<0 && ay>=0) q[2]=1;
      if(ax>=0 && ay>=0) q[3]=1;
    }
    const quadrants = q.reduce((s,v)=>s+v,0);
    return quadrants >= 3;
  }

  function localXY(e){
    const rect = deckArea.getBoundingClientRect();
    const x = (e.clientX - rect.left);
    const y = (e.clientY - rect.top);
    return {x,y};
  }

  deckArea.addEventListener("pointerdown", (e)=>{
    if(currentPage !== 1) return;
    const {x,y} = localXY(e);
    startStroke(x,y);
  });
  deckArea.addEventListener("pointermove", (e)=>{
    if(currentPage !== 1) return;
    if(!drawing) return;
    const {x,y} = localXY(e);
    moveStroke(x,y);
  });
  window.addEventListener("pointerup", async ()=>{
    if(currentPage !== 1) return;
    await endStroke();
  });

  window.addEventListener("keydown", async (e)=>{
    if(e.key.toLowerCase() === "r" && currentPage === 1){
      toast("✨ 重新洗牌");
      await doShuffle(false);
    }
  });
</script>
</body>
</html>
